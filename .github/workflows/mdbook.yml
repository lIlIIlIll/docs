# Sample workflow for building and deploying a mdBook site to GitHub Pages
#
# To get started with mdBook see: https://rust-lang.github.io/mdBook/index.html
#
name: Deploy mdBook site to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild (skip SHA cache check)"
        type: boolean
        default: false
      std_branch:
        description: "Branch/tag for cangjie_runtime (std)"
        type: string
        default: "dev"
      stdx_branch:
        description: "Branch/tag for cangjie_stdx (stdx)"
        type: string
        default: "dev"
      std_prs:
        description: "Comma/space-separated PR numbers or commits to cherry-pick into std"
        type: string
        default: ""
      stdx_prs:
        description: "Comma/space-separated PR numbers or commits to cherry-pick into stdx"
        type: string
        default: ""
  schedule:
    - cron: "0 1-10 * * 1-5"

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: 0.4.52
      FORCE_REBUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_rebuild || vars.FORCE_REBUILD || 'false' }}
      STD_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.std_branch || vars.STD_BRANCH || 'dev' }}
      STDX_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.stdx_branch || vars.STDX_BRANCH || 'dev' }}
      STD_PRS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.std_prs || '' }}
      STDX_PRS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.stdx_prs || '' }}

    steps:
      - uses: actions/checkout@v4
      - name: Prepare cache dirs
        run: |
          set -euxo pipefail
          mkdir -p .ext-build-cache
          mkdir -p "$HOME/.cargo/bin" "$HOME/.cargo/registry" "$HOME/.cargo/git" target

      - name: Resolve build options
        run: |
          set -euo pipefail
          custom="false"
          if [[ -n "${STD_PRS}" || -n "${STDX_PRS}" || "${STD_BRANCH}" != "dev" || "${STDX_BRANCH}" != "dev" ]]; then
            custom="true"
          fi
          force="${FORCE_REBUILD}"
          if [[ "$custom" == "true" ]]; then
            force="true"
          fi
          echo "CUSTOM_BUILD=$custom" >> "$GITHUB_ENV"
          echo "FORCE_REBUILD=$force" >> "$GITHUB_ENV"
          echo "STD_OUT_DIR=$GITHUB_WORKSPACE/book/std" >> "$GITHUB_ENV"
          echo "STDX_OUT_DIR=$GITHUB_WORKSPACE/book/stdx" >> "$GITHUB_ENV"
          echo "STD_PR_OUT_DIR=$GITHUB_WORKSPACE/book/pr/std" >> "$GITHUB_ENV"
          echo "STDX_PR_OUT_DIR=$GITHUB_WORKSPACE/book/pr/stdx" >> "$GITHUB_ENV"

      - name: Restore PR book cache
        uses: actions/cache@v4
        with:
          path: book/pr
          key: book-pr-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            book-pr-${{ github.ref_name }}-

      - name: Clone cangjie_runtime (dev)
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_runtime.git -b dev ext
          ls -R ext

      - name: Clone cangjie-stdx (dev)
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_stdx.git -b dev ext_stdx
          ls -R ext_stdx

      - name: Clone cangjie_runtime (custom)
        if: ${{ env.CUSTOM_BUILD == 'true' }}
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_runtime.git -b "$STD_BRANCH" ext_pr
          ls -R ext_pr

      - name: Clone cangjie-stdx (custom)
        if: ${{ env.CUSTOM_BUILD == 'true' }}
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_stdx.git -b "$STDX_BRANCH" ext_stdx_pr
          ls -R ext_stdx_pr

      - name: Cherry-pick PRs (custom)
        if: ${{ env.STD_PRS != '' || env.STDX_PRS != '' }}
        run: |
          set -euo pipefail
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          cherry_pick_prs() {
            local repo_dir="$1"
            local prs="$2"
            if [[ -z "$prs" ]]; then
              return 0
            fi

            echo "Cherry-picking into $repo_dir: $prs"
            for pr in $(echo "$prs" | tr ',' ' '); do
              pr="${pr//[[:space:]]/}"
              [[ -z "$pr" ]] && continue

              if [[ "$pr" =~ ^[0-9]+$ ]]; then
                local ref=""
                for cand in "refs/pull/$pr/head" "pull/$pr/head" "refs/merge-requests/$pr/head"; do
                  if git -C "$repo_dir" fetch origin "$cand":pr-"$pr"; then
                    ref="pr-$pr"
                    break
                  fi
                done
                if [[ -z "$ref" ]]; then
                  echo "Failed to fetch PR $pr for $repo_dir" >&2
                  exit 1
                fi
                git -C "$repo_dir" cherry-pick "$ref"
              else
                git -C "$repo_dir" cherry-pick "$pr"
              fi
            done
          }

          cherry_pick_prs ext_pr "$STD_PRS"
          cherry_pick_prs ext_stdx_pr "$STDX_PRS"

      - name: Get ext SHAs
        id: extsha
        run: |
          set -euo pipefail
          RUNTIME_SHA=$(git -C ext rev-parse HEAD)
          STDX_SHA=$(git -C ext_stdx rev-parse HEAD)
          echo "runtime_sha=$RUNTIME_SHA" >> $GITHUB_OUTPUT
          echo "stdx_sha=$STDX_SHA"       >> $GITHUB_OUTPUT
          echo "Runtime: $RUNTIME_SHA"
          echo "Stdx   : $STDX_SHA"

      - name: Check cache by SHAs
        id: cachecheck
        if: ${{ env.FORCE_REBUILD != 'true' }}
        uses: actions/cache@v4
        with:
          path: .ext-build-cache
          key: ext-sha-${{ steps.extsha.outputs.runtime_sha }}-${{ steps.extsha.outputs.stdx_sha }}

      - name: Skip if no upstream changes
        if: steps.cachecheck.outputs.cache-hit == 'true'
        run: |
          echo "No upstream changes. Skipping build & deploy."
          exit 0

      - name: Prepare std book
        run: |
          set -euxo pipefail
          mkdir -p src/vendor/gitcode
          rsync -a --delete ext/stdlib/doc/libs/ src/vendor/gitcode/

          cp -r src/vendor/gitcode/* src/
          rm -r src/std_en
          rm src/summary_cjnative_EN.md
          mv -f src/summary_cjnative.md src/SUMMARY.md

      - name: Prepare stdx book (isolated build dir)
        run: |
          set -euxo pipefail
          mkdir -p stdx_book/src stdx_book/theme stdx_book/scripts
          rsync -a --delete ext_stdx/doc/* stdx_book/src/
          test -f stdx_book/src/summary_cjnative.md && mv -f stdx_book/src/summary_cjnative.md stdx_book/src/SUMMARY.md
          cp -r theme/* stdx_book/theme/
          cp scripts/* stdx_book/scripts/
          cp book.toml stdx_book/book.toml

      - name: Prepare std book (custom)
        if: ${{ env.CUSTOM_BUILD == 'true' }}
        run: |
          set -euxo pipefail
          mkdir -p std_pr_book/src std_pr_book/theme std_pr_book/scripts
          mkdir -p std_pr_book/src/vendor/gitcode
          rsync -a --delete ext_pr/stdlib/doc/libs/ std_pr_book/src/vendor/gitcode/

          cp -r std_pr_book/src/vendor/gitcode/* std_pr_book/src/
          rm -r std_pr_book/src/std_en
          rm std_pr_book/src/summary_cjnative_EN.md
          mv -f std_pr_book/src/summary_cjnative.md std_pr_book/src/SUMMARY.md
          cp -r theme/* std_pr_book/theme/
          cp scripts/* std_pr_book/scripts/
          cp book.toml std_pr_book/book.toml

      - name: Prepare stdx book (custom, isolated build dir)
        if: ${{ env.CUSTOM_BUILD == 'true' }}
        run: |
          set -euxo pipefail
          mkdir -p stdx_pr_book/src stdx_pr_book/theme stdx_pr_book/scripts
          rsync -a --delete ext_stdx_pr/doc/* stdx_pr_book/src/
          test -f stdx_pr_book/src/summary_cjnative.md && mv -f stdx_pr_book/src/summary_cjnative.md stdx_pr_book/src/SUMMARY.md
          cp -r theme/* stdx_pr_book/theme/
          cp scripts/* stdx_pr_book/scripts/
          cp book.toml stdx_pr_book/book.toml

      - name: Sanity check
        run: |
          ls -la src | sed -n '1,200p'
          test -f src/SUMMARY.md
          sed -n '1,10p' src/SUMMARY.md

          ls -la stdx_book/src | sed -n '1,80p'
          echo "ls stdx_book/theme"
          ls -la stdx_book/theme/*

          echo "ls stdx_book/scripts"

          ls -la stdx_book/scripts/*
          test -f stdx_book/src/SUMMARY.md
          sed -n '1,10p' stdx_book/book.toml
          sed -n '1,10p' stdx_book/scripts/table.py

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-mdbook
          restore-keys: |
            ${{ runner.os }}-cargo-mdbook

      - name: Install Rust (for cargo)
        uses: dtolnay/rust-toolchain@stable

      - name: Install mdBook (pinned)
        run: |
          if ! command -v mdbook >/dev/null; then
            cargo install --locked mdbook --version ${MDBOOK_VERSION}
          fi
          mdbook --version

      - name: Install mdbook-admonish (if needed)
        shell: bash
        env:
          MDBOOK_ADMONISH_VERSION: "1.20.0"
        run: |
          set -euo pipefail
          want_ver="mdbook-admonish $MDBOOK_ADMONISH_VERSION"
          if ! command -v mdbook-admonish >/dev/null; then
            echo "mdbook-admonish not found. Installing..."
            cargo install mdbook-admonish --locked --version "$MDBOOK_ADMONISH_VERSION"
          else
            have_ver="$(mdbook-admonish --version || true)"
            if [[ "$have_ver" == "$want_ver" ]]; then
              echo "mdbook-admonish already $have_ver, skip."
            else
              echo "mdbook-admonish is $have_ver, want $want_ver. Reinstalling..."
              cargo install mdbook-admonish --locked --version "$MDBOOK_ADMONISH_VERSION" --force
            fi
          fi

      - name: Install mdbook-pagetoc(if needed)
        shell: bash
        env:
          MDBOOK_PAGETOC_VERSION: "0.2.2"
        run: |
          set -euo pipefail
          if ! command -v mdbook-pagetoc >/dev/null; then
            echo "mdbook-pagetoc not found. Installing..."
            cargo install mdbook-pagetoc --locked --version "$MDBOOK_PAGETOC_VERSION"
          fi

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Print mdBook env & where is book.toml
        run: |
          set -euxo pipefail
          mdbook -V
          echo "WORKSPACE = $GITHUB_WORKSPACE"
          echo "--- repo root ---"
          ls -la
          echo "--- show book.toml (if any) ---"
          sed -n '1,120p' book.toml || true

      - name: Build std mdBook
        run: |
          set -euxo pipefail
          mdbook-admonish install
          BASE_TITLE="Cangjie Std API"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$STD_OUT_DIR"
          echo "--- built dirs ---"
          find "$GITHUB_WORKSPACE" -maxdepth 4 -type d -name book -print
          echo "--- book/ listing ---"
          ls -la "$STD_OUT_DIR"

      - name: Build cangjie-stdx into /book/stdx
        run: |
          set -euxo pipefail
          ls -al stdx_book/
          cd stdx_book && mdbook-admonish install
          BASE_TITLE="Cangjie Stdx API"  # 或者用 tomlq/yq 读 book.toml
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$STDX_OUT_DIR"
          test -f "$STDX_OUT_DIR/index.html"

      - name: Build std mdBook (custom)
        if: ${{ env.CUSTOM_BUILD == 'true' }}
        run: |
          set -euxo pipefail
          cd std_pr_book && mdbook-admonish install
          BASE_TITLE="Cangjie Std API"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$STD_PR_OUT_DIR"
          test -f "$STD_PR_OUT_DIR/index.html"

      - name: Build cangjie-stdx (custom) into /book/pr/stdx
        if: ${{ env.CUSTOM_BUILD == 'true' }}
        run: |
          set -euxo pipefail
          cd stdx_pr_book && mdbook-admonish install
          BASE_TITLE="Cangjie Stdx API"  # 或者用 tomlq/yq 读 book.toml
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$STDX_PR_OUT_DIR"
          test -f "$STDX_PR_OUT_DIR/index.html"

      - name: Assert book exists
        run: |
          set -euxo pipefail
          test -d "$GITHUB_WORKSPACE/book"
          test -f "$STD_OUT_DIR/index.html" || (echo "index.html missing; build likely ran in wrong dir" && exit 2)
          grep -nE 'pagetoc\.(js|css)' "$STD_OUT_DIR/index.html" || echo '未引入 pagetoc 资源'
          find book -path '*/theme/pagetoc.*' -print || echo 'book/std/theme 下没找到 pagetoc.*'
          grep -nE 'class="pagetoc|id="pagetoc' "$STD_OUT_DIR/index.html" || echo '页面里没有 pagetoc 容器（JS 可能没运行）'
          if [[ "${CUSTOM_BUILD}" == "true" ]]; then
            test -f "$STD_PR_OUT_DIR/index.html" || (echo "pr std index.html missing" && exit 2)
            test -f "$STDX_PR_OUT_DIR/index.html" || (echo "pr stdx index.html missing" && exit 2)
          fi
          find book -maxdepth 4 -type f -name 'toc.js' -print

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./book
  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
