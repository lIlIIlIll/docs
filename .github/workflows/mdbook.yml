# Sample workflow for building and deploying a mdBook site to GitHub Pages
#
# To get started with mdBook see: https://rust-lang.github.io/mdBook/index.html
#
name: Deploy mdBook site to Pages
on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild (skip SHA cache check)"
        type: boolean
        default: false
      std_branch:
        description: "Base branch/tag for PR cherry-pick (std)"
        type: string
        default: "dev"
      stdx_branch:
        description: "Base branch/tag for PR cherry-pick (stdx)"
        type: string
        default: "dev"
      pr_id:
        description: "PR ID for /pr/<id> output path"
        type: string
        default: ""
      std_prs:
        description: "Comma/space-separated PR numbers or commits to cherry-pick into std"
        type: string
        default: ""
      stdx_prs:
        description: "Comma/space-separated PR numbers or commits to cherry-pick into stdx"
        type: string
        default: ""
  schedule:
    - cron: "0 1-10 * * 1-5"
# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false
jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decide.outputs.should_deploy }}
    env:
      MDBOOK_VERSION: 0.5.2
      MDBOOK_GITINFO_VERSION: 2.0.0
      MDBOOK_PAGETOC_VERSION: 0.3.0
      FORCE_REBUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_rebuild || vars.FORCE_REBUILD || 'false' }}
      STD_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.std_branch || vars.STD_BRANCH || 'dev' }}
      STDX_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.stdx_branch || vars.STDX_BRANCH || 'dev' }}
      PR_ID: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_id || '' }}
      STD_PRS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.std_prs || '' }}
      STDX_PRS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.stdx_prs || '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Prepare cache dirs
        run: |
          set -euxo pipefail
          mkdir -p .ext-build-cache
          mkdir -p "$HOME/.cargo/bin" "$HOME/.cargo/registry" "$HOME/.cargo/git" target
      - name: Resolve build options
        run: |
          set -euo pipefail
          pr_id="${PR_ID}"
          build_pr="false"
          if [[ -n "$pr_id" || -n "${STD_PRS}" || -n "${STDX_PRS}" ]]; then
            build_pr="true"
          fi
          if [[ "$build_pr" == "true" && -z "$pr_id" ]]; then
            echo "PR_ID is required when building PR docs." >&2
            exit 1
          fi
          if [[ "$build_pr" == "true" && ! "$pr_id" =~ ^[0-9]+$ ]]; then
            echo "PR_ID must be numeric (example: 123)." >&2
            exit 1
          fi
          force="${FORCE_REBUILD}"
          force_deploy="false"
          if [[ "$build_pr" == "true" ]]; then
            force_deploy="true"
          fi
          echo "BUILD_PR=$build_pr" >> "$GITHUB_ENV"
          echo "FORCE_REBUILD=$force" >> "$GITHUB_ENV"
          echo "FORCE_DEPLOY=$force_deploy" >> "$GITHUB_ENV"
          echo "DEV_STD_OUT_DIR=$GITHUB_WORKSPACE/book/dev/std" >> "$GITHUB_ENV"
          echo "DEV_STDX_OUT_DIR=$GITHUB_WORKSPACE/book/dev/stdx" >> "$GITHUB_ENV"
          echo "MAIN_STD_OUT_DIR=$GITHUB_WORKSPACE/book/main/std" >> "$GITHUB_ENV"
          echo "MAIN_STDX_OUT_DIR=$GITHUB_WORKSPACE/book/main/stdx" >> "$GITHUB_ENV"
          echo "RELEASE_STD_OUT_DIR=$GITHUB_WORKSPACE/book/release/1.0/std" >> "$GITHUB_ENV"
          echo "RELEASE_STDX_OUT_DIR=$GITHUB_WORKSPACE/book/release/1.0/stdx" >> "$GITHUB_ENV"
          if [[ "$build_pr" == "true" ]]; then
            pr_root="$GITHUB_WORKSPACE/book/pr/$pr_id"
            echo "PR_OUT_ROOT=$pr_root" >> "$GITHUB_ENV"
            echo "PR_STD_OUT_DIR=$pr_root/std" >> "$GITHUB_ENV"
            echo "PR_STDX_OUT_DIR=$pr_root/stdx" >> "$GITHUB_ENV"
          fi
      - name: Restore PR book cache
        uses: actions/cache@v4
        with:
          path: book/pr
          key: book-pr-${{ github.ref_name }}-${{ env.PR_ID != '' && env.PR_ID || 'none' }}
          restore-keys: |
            book-pr-${{ github.ref_name }}-
      - name: Prune old PR books
        run: |
          set -euo pipefail
          pr_root="$GITHUB_WORKSPACE/book/pr"
          if [[ ! -d "$pr_root" ]]; then
            exit 0
          fi
          now=$(date +%s)
          pruned="false"
          for dir in "$pr_root"/*; do
            [[ -d "$dir" ]] || continue
            stamp="$dir/.stamp"
            [[ -f "$stamp" ]] || continue
            ts=$(tr -d ' \n' < "$stamp" || true)
            if [[ "$ts" =~ ^[0-9]+$ ]]; then
              age=$((now - ts))
              if (( age > 604800 )); then
                echo "Prune old PR book: $dir"
                rm -rf "$dir"
                pruned="true"
              fi
            fi
          done
          if [[ "$pruned" == "true" ]]; then
            echo "FORCE_DEPLOY=true" >> "$GITHUB_ENV"
          fi
      - name: Clone ext repos
        run: |
          set -euo pipefail
          source scripts/ci/mdbook_lib.sh
          clone_ext_repo https://gitcode.com/Cangjie/cangjie_runtime.git ext_runtime "${STD_BRANCH}"
          clone_ext_repo https://gitcode.com/Cangjie/cangjie_stdx.git ext_stdx "${STDX_BRANCH}"
          ls -la ext_runtime
          ls -la ext_stdx
      - name: Get ext SHAs
        id: extsha
        run: |
          set -euo pipefail
          source scripts/ci/mdbook_lib.sh
          RUNTIME_DEV_SHA=$(get_sha ext_runtime origin/dev)
          STDX_DEV_SHA=$(get_sha ext_stdx origin/dev)
          RUNTIME_MAIN_SHA=$(get_sha ext_runtime origin/main)
          STDX_MAIN_SHA=$(get_sha ext_stdx origin/main)
          RUNTIME_RELEASE_SHA=$(get_sha ext_runtime origin/release/1.0)
          STDX_RELEASE_SHA=$(get_sha ext_stdx origin/release/1.0)
          echo "runtime_dev_sha=$RUNTIME_DEV_SHA"   >> $GITHUB_OUTPUT
          echo "stdx_dev_sha=$STDX_DEV_SHA"         >> $GITHUB_OUTPUT
          echo "runtime_main_sha=$RUNTIME_MAIN_SHA" >> $GITHUB_OUTPUT
          echo "stdx_main_sha=$STDX_MAIN_SHA"       >> $GITHUB_OUTPUT
          echo "runtime_release_sha=$RUNTIME_RELEASE_SHA" >> $GITHUB_OUTPUT
          echo "stdx_release_sha=$STDX_RELEASE_SHA"       >> $GITHUB_OUTPUT
          echo "Runtime dev : $RUNTIME_DEV_SHA"
          echo "Stdx dev    : $STDX_DEV_SHA"
          echo "Runtime main: $RUNTIME_MAIN_SHA"
          echo "Stdx main   : $STDX_MAIN_SHA"
          echo "Runtime rel : $RUNTIME_RELEASE_SHA"
          echo "Stdx rel    : $STDX_RELEASE_SHA"
          mkdir -p .ext-build-cache
          cat > .ext-build-cache/sha.txt <<EOF
          runtime_dev_sha=$RUNTIME_DEV_SHA
          stdx_dev_sha=$STDX_DEV_SHA
          runtime_main_sha=$RUNTIME_MAIN_SHA
          stdx_main_sha=$STDX_MAIN_SHA
          runtime_release_sha=$RUNTIME_RELEASE_SHA
          stdx_release_sha=$STDX_RELEASE_SHA
          EOF
      - name: Check cache by SHAs
        id: cachecheck
        if: ${{ env.FORCE_REBUILD != 'true' }}
        uses: actions/cache@v4
        with:
          path: .ext-build-cache
          key: ext-sha-${{ steps.extsha.outputs.runtime_dev_sha }}-${{ steps.extsha.outputs.stdx_dev_sha }}-${{ steps.extsha.outputs.runtime_main_sha }}-${{ steps.extsha.outputs.stdx_main_sha }}-${{ steps.extsha.outputs.runtime_release_sha }}-${{ steps.extsha.outputs.stdx_release_sha }}
      - name: Decide skip build/deploy
        id: decide
        env:
          CACHE_HIT: ${{ steps.cachecheck.outputs.cache-hit }}
        run: |
          set -euo pipefail
          skip="false"
          cache_hit="${CACHE_HIT:-false}"
          if [[ "${FORCE_REBUILD}" != "true" && "$cache_hit" == "true" && "${BUILD_PR}" != "true" && "${FORCE_DEPLOY}" != "true" ]]; then
            skip="true"
          fi
          echo "SKIP_BUILD=$skip" >> "$GITHUB_ENV"
          echo "skip_build=$skip" >> "$GITHUB_OUTPUT"
          if [[ "$skip" == "true" ]]; then
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
          fi
      - name: Restore dev book output cache
        id: cache_book_dev
        if: ${{ env.SKIP_BUILD != 'true' }}
        uses: actions/cache@v4
        with:
          path: book/dev
          key: book-dev-${{ steps.extsha.outputs.runtime_dev_sha }}-${{ steps.extsha.outputs.stdx_dev_sha }}
      - name: Restore main book output cache
        id: cache_book_main
        if: ${{ env.SKIP_BUILD != 'true' }}
        uses: actions/cache@v4
        with:
          path: book/main
          key: book-main-${{ steps.extsha.outputs.runtime_main_sha }}-${{ steps.extsha.outputs.stdx_main_sha }}
      - name: Restore release book output cache
        id: cache_book_release
        if: ${{ env.SKIP_BUILD != 'true' }}
        uses: actions/cache@v4
        with:
          path: book/release/1.0
          key: book-release-${{ steps.extsha.outputs.runtime_release_sha }}-${{ steps.extsha.outputs.stdx_release_sha }}
      - name: Decide branch builds
        if: ${{ env.SKIP_BUILD != 'true' }}
        run: |
          set -euo pipefail
          build_dev="true"
          build_main="true"
          build_release="true"
          if [[ "${FORCE_REBUILD}" != "true" && "${CACHE_DEV_HIT}" == "true" ]]; then
            build_dev="false"
          fi
          if [[ "${FORCE_REBUILD}" != "true" && "${CACHE_MAIN_HIT}" == "true" ]]; then
            build_main="false"
          fi
          if [[ "${FORCE_REBUILD}" != "true" && "${CACHE_RELEASE_HIT}" == "true" ]]; then
            build_release="false"
          fi
          echo "BUILD_DEV=$build_dev" >> "$GITHUB_ENV"
          echo "BUILD_MAIN=$build_main" >> "$GITHUB_ENV"
          echo "BUILD_RELEASE=$build_release" >> "$GITHUB_ENV"
        env:
          CACHE_DEV_HIT: ${{ steps.cache_book_dev.outputs.cache-hit }}
          CACHE_MAIN_HIT: ${{ steps.cache_book_main.outputs.cache-hit }}
          CACHE_RELEASE_HIT: ${{ steps.cache_book_release.outputs.cache-hit }}
      - name: Checkout PR base branches
        if: ${{ env.SKIP_BUILD != 'true' && env.BUILD_PR == 'true' }}
        run: |
          set -euo pipefail
          source scripts/ci/mdbook_lib.sh
          unshallow_repo ext_runtime
          unshallow_repo ext_stdx
          checkout_ref ext_runtime "$STD_BRANCH"
          checkout_ref ext_stdx "$STDX_BRANCH"
      - name: Cherry-pick PRs (custom)
        if: ${{ env.SKIP_BUILD != 'true' && env.BUILD_PR == 'true' && (env.STD_PRS != '' || env.STDX_PRS != '') }}
        run: |
          set -euo pipefail
          source scripts/ci/mdbook_lib.sh
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          cherry_pick_prs() {
            local repo_dir="$1"
            local prs="$2"
            if [[ -z "$prs" ]]; then
              return 0
            fi

            echo "Cherry-picking into $repo_dir: $prs"
            for pr in $(echo "$prs" | tr ',' ' '); do
              pr="${pr//[[:space:]]/}"
              [[ -z "$pr" ]] && continue

              if [[ "$pr" =~ ^[0-9]+$ ]]; then
                local ref=""
                for cand in "refs/pull/$pr/head" "pull/$pr/head" "refs/merge-requests/$pr/head"; do
                  if git -C "$repo_dir" fetch origin "$cand":pr-"$pr"; then
                    ref="pr-$pr"
                    break
                  fi
                done
                if [[ -z "$ref" ]]; then
                  echo "Failed to fetch PR $pr for $repo_dir" >&2
                  exit 1
                fi
                git -C "$repo_dir" cherry-pick "$ref"
              else
                git -C "$repo_dir" cherry-pick "$pr"
              fi
            done
          }

          cherry_pick_prs ext_runtime "$STD_PRS"
          cherry_pick_prs ext_stdx "$STDX_PRS"
      - name: Cache cargo
        if: ${{ env.SKIP_BUILD != 'true' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-mdbook-${{ env.MDBOOK_VERSION }}-${{ env.MDBOOK_PAGETOC_VERSION }}-${{ env.MDBOOK_GITINFO_VERSION }}
          restore-keys: |
            ${{ runner.os }}-cargo-mdbook-
      - name: Install Rust (for cargo)
        if: ${{ env.SKIP_BUILD != 'true' }}
        uses: dtolnay/rust-toolchain@stable
      - name: Install mdBook tooling
        if: ${{ env.SKIP_BUILD != 'true' }}
        run: |
          set -euo pipefail
          source scripts/ci/mdbook_lib.sh
          force="${FORCE_REBUILD}"
          ensure_tool_version mdbook "${MDBOOK_VERSION}" "cargo install --locked mdbook --version ${MDBOOK_VERSION} --force" "$force"
          ensure_tool_version mdbook-gitinfo "${MDBOOK_GITINFO_VERSION}" "cargo install --locked mdbook-gitinfo --version ${MDBOOK_GITINFO_VERSION} --force" "$force"
          ensure_tool_version mdbook-pagetoc "${MDBOOK_PAGETOC_VERSION}" "cargo install mdbook-pagetoc --locked --version ${MDBOOK_PAGETOC_VERSION} --force" "$force"
          mdbook --version
          mdbook-gitinfo --version
      - name: Setup Pages
        if: ${{ env.SKIP_BUILD != 'true' }}
        id: pages
        uses: actions/configure-pages@v5
      - name: Build books
        if: ${{ env.SKIP_BUILD != 'true' }}
        run: |
          set -euxo pipefail
          bash scripts/ci/build_books.sh
      - name: Upload artifact
        if: ${{ env.SKIP_BUILD != 'true' }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./book
  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: ${{ needs.build.outputs.should_deploy == 'true' }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
