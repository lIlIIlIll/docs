# Sample workflow for building and deploying a mdBook site to GitHub Pages
#
# To get started with mdBook see: https://rust-lang.github.io/mdBook/index.html
#
name: Deploy mdBook site to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild (skip SHA cache check)"
        type: boolean
        default: false
      std_branch:
        description: "Base branch/tag for PR cherry-pick (std)"
        type: string
        default: "dev"
      stdx_branch:
        description: "Base branch/tag for PR cherry-pick (stdx)"
        type: string
        default: "dev"
      pr_id:
        description: "PR ID for /pr/<id> output path"
        type: string
        default: ""
      std_prs:
        description: "Comma/space-separated PR numbers or commits to cherry-pick into std"
        type: string
        default: ""
      stdx_prs:
        description: "Comma/space-separated PR numbers or commits to cherry-pick into stdx"
        type: string
        default: ""
  schedule:
    - cron: "0 1-10 * * 1-5"

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: 0.4.52
      FORCE_REBUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_rebuild || vars.FORCE_REBUILD || 'false' }}
      STD_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.std_branch || vars.STD_BRANCH || 'dev' }}
      STDX_BRANCH: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.stdx_branch || vars.STDX_BRANCH || 'dev' }}
      PR_ID: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.pr_id || '' }}
      STD_PRS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.std_prs || '' }}
      STDX_PRS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.stdx_prs || '' }}

    steps:
      - uses: actions/checkout@v4
      - name: Prepare cache dirs
        run: |
          set -euxo pipefail
          mkdir -p .ext-build-cache
          mkdir -p "$HOME/.cargo/bin" "$HOME/.cargo/registry" "$HOME/.cargo/git" target

      - name: Resolve build options
        run: |
          set -euo pipefail
          pr_id="${PR_ID}"
          build_pr="false"
          if [[ -n "$pr_id" || -n "${STD_PRS}" || -n "${STDX_PRS}" ]]; then
            build_pr="true"
          fi
          if [[ "$build_pr" == "true" && -z "$pr_id" ]]; then
            echo "PR_ID is required when building PR docs." >&2
            exit 1
          fi
          if [[ "$build_pr" == "true" && ! "$pr_id" =~ ^[0-9]+$ ]]; then
            echo "PR_ID must be numeric (example: 123)." >&2
            exit 1
          fi
          force="${FORCE_REBUILD}"
          if [[ "$build_pr" == "true" ]]; then
            force="true"
          fi
          echo "BUILD_PR=$build_pr" >> "$GITHUB_ENV"
          echo "FORCE_REBUILD=$force" >> "$GITHUB_ENV"
          echo "DEV_STD_OUT_DIR=$GITHUB_WORKSPACE/book/dev/std" >> "$GITHUB_ENV"
          echo "DEV_STDX_OUT_DIR=$GITHUB_WORKSPACE/book/dev/stdx" >> "$GITHUB_ENV"
          echo "MAIN_STD_OUT_DIR=$GITHUB_WORKSPACE/book/main/std" >> "$GITHUB_ENV"
          echo "MAIN_STDX_OUT_DIR=$GITHUB_WORKSPACE/book/main/stdx" >> "$GITHUB_ENV"
          if [[ "$build_pr" == "true" ]]; then
            pr_root="$GITHUB_WORKSPACE/book/pr/$pr_id"
            echo "PR_OUT_ROOT=$pr_root" >> "$GITHUB_ENV"
            echo "PR_STD_OUT_DIR=$pr_root/std" >> "$GITHUB_ENV"
            echo "PR_STDX_OUT_DIR=$pr_root/stdx" >> "$GITHUB_ENV"
          fi

      - name: Restore PR book cache
        uses: actions/cache@v4
        with:
          path: book/pr
          key: book-pr-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            book-pr-${{ github.ref_name }}-

      - name: Prune old PR books
        run: |
          set -euo pipefail
          pr_root="$GITHUB_WORKSPACE/book/pr"
          if [[ ! -d "$pr_root" ]]; then
            exit 0
          fi
          now=$(date +%s)
          pruned="false"
          for dir in "$pr_root"/*; do
            [[ -d "$dir" ]] || continue
            stamp="$dir/.stamp"
            [[ -f "$stamp" ]] || continue
            ts=$(tr -d ' \n' < "$stamp" || true)
            if [[ "$ts" =~ ^[0-9]+$ ]]; then
              age=$((now - ts))
              if (( age > 604800 )); then
                echo "Prune old PR book: $dir"
                rm -rf "$dir"
                pruned="true"
              fi
            fi
          done
          if [[ "$pruned" == "true" ]]; then
            echo "FORCE_REBUILD=true" >> "$GITHUB_ENV"
          fi

      - name: Clone cangjie_runtime (dev)
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_runtime.git -b dev ext_dev
          ls -R ext_dev

      - name: Clone cangjie-stdx (dev)
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_stdx.git -b dev ext_stdx_dev
          ls -R ext_stdx_dev

      - name: Clone cangjie_runtime (main)
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_runtime.git -b main ext_main
          ls -R ext_main

      - name: Clone cangjie-stdx (main)
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_stdx.git -b main ext_stdx_main
          ls -R ext_stdx_main

      - name: Clone cangjie_runtime (pr base)
        if: ${{ env.BUILD_PR == 'true' }}
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_runtime.git -b "$STD_BRANCH" ext_pr
          ls -R ext_pr

      - name: Clone cangjie-stdx (pr base)
        if: ${{ env.BUILD_PR == 'true' }}
        run: |
          git clone https://gitcode.com/Cangjie/cangjie_stdx.git -b "$STDX_BRANCH" ext_stdx_pr
          ls -R ext_stdx_pr

      - name: Cherry-pick PRs (custom)
        if: ${{ env.STD_PRS != '' || env.STDX_PRS != '' }}
        run: |
          set -euo pipefail
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          cherry_pick_prs() {
            local repo_dir="$1"
            local prs="$2"
            if [[ -z "$prs" ]]; then
              return 0
            fi

            echo "Cherry-picking into $repo_dir: $prs"
            for pr in $(echo "$prs" | tr ',' ' '); do
              pr="${pr//[[:space:]]/}"
              [[ -z "$pr" ]] && continue

              if [[ "$pr" =~ ^[0-9]+$ ]]; then
                local ref=""
                for cand in "refs/pull/$pr/head" "pull/$pr/head" "refs/merge-requests/$pr/head"; do
                  if git -C "$repo_dir" fetch origin "$cand":pr-"$pr"; then
                    ref="pr-$pr"
                    break
                  fi
                done
                if [[ -z "$ref" ]]; then
                  echo "Failed to fetch PR $pr for $repo_dir" >&2
                  exit 1
                fi
                git -C "$repo_dir" cherry-pick "$ref"
              else
                git -C "$repo_dir" cherry-pick "$pr"
              fi
            done
          }

          cherry_pick_prs ext_pr "$STD_PRS"
          cherry_pick_prs ext_stdx_pr "$STDX_PRS"

      - name: Get ext SHAs
        id: extsha
        run: |
          set -euo pipefail
          RUNTIME_DEV_SHA=$(git -C ext_dev rev-parse HEAD)
          STDX_DEV_SHA=$(git -C ext_stdx_dev rev-parse HEAD)
          RUNTIME_MAIN_SHA=$(git -C ext_main rev-parse HEAD)
          STDX_MAIN_SHA=$(git -C ext_stdx_main rev-parse HEAD)
          echo "runtime_dev_sha=$RUNTIME_DEV_SHA"   >> $GITHUB_OUTPUT
          echo "stdx_dev_sha=$STDX_DEV_SHA"         >> $GITHUB_OUTPUT
          echo "runtime_main_sha=$RUNTIME_MAIN_SHA" >> $GITHUB_OUTPUT
          echo "stdx_main_sha=$STDX_MAIN_SHA"       >> $GITHUB_OUTPUT
          echo "Runtime dev : $RUNTIME_DEV_SHA"
          echo "Stdx dev    : $STDX_DEV_SHA"
          echo "Runtime main: $RUNTIME_MAIN_SHA"
          echo "Stdx main   : $STDX_MAIN_SHA"

      - name: Check cache by SHAs
        id: cachecheck
        if: ${{ env.FORCE_REBUILD != 'true' }}
        uses: actions/cache@v4
        with:
          path: .ext-build-cache
          key: ext-sha-${{ steps.extsha.outputs.runtime_dev_sha }}-${{ steps.extsha.outputs.stdx_dev_sha }}-${{ steps.extsha.outputs.runtime_main_sha }}-${{ steps.extsha.outputs.stdx_main_sha }}

      - name: Skip if no upstream changes
        if: steps.cachecheck.outputs.cache-hit == 'true'
        run: |
          echo "No upstream changes. Skipping build & deploy."
          exit 0

      - name: Prepare std book (dev)
        run: |
          set -euxo pipefail
          mkdir -p std_dev_book/src std_dev_book/theme std_dev_book/scripts
          mkdir -p std_dev_book/src/vendor/gitcode
          rsync -a --delete ext_dev/stdlib/doc/libs/ std_dev_book/src/vendor/gitcode/

          cp -r std_dev_book/src/vendor/gitcode/* std_dev_book/src/
          rm -rf std_dev_book/src/std_en
          rm -f std_dev_book/src/summary_cjnative_EN.md
          mv -f std_dev_book/src/summary_cjnative.md std_dev_book/src/SUMMARY.md
          cp -r theme/* std_dev_book/theme/
          cp scripts/* std_dev_book/scripts/
          cp book.toml std_dev_book/book.toml

      - name: Prepare stdx book (dev)
        run: |
          set -euxo pipefail
          mkdir -p stdx_dev_book/src stdx_dev_book/theme stdx_dev_book/scripts
          rsync -a --delete ext_stdx_dev/doc/* stdx_dev_book/src/
          test -f stdx_dev_book/src/summary_cjnative.md && mv -f stdx_dev_book/src/summary_cjnative.md stdx_dev_book/src/SUMMARY.md
          cp -r theme/* stdx_dev_book/theme/
          cp scripts/* stdx_dev_book/scripts/
          cp book.toml stdx_dev_book/book.toml

      - name: Prepare std book (main)
        run: |
          set -euxo pipefail
          mkdir -p std_main_book/src std_main_book/theme std_main_book/scripts
          mkdir -p std_main_book/src/vendor/gitcode
          rsync -a --delete ext_main/stdlib/doc/libs/ std_main_book/src/vendor/gitcode/

          cp -r std_main_book/src/vendor/gitcode/* std_main_book/src/
          rm -rf std_main_book/src/std_en
          rm -f std_main_book/src/summary_cjnative_EN.md
          mv -f std_main_book/src/summary_cjnative.md std_main_book/src/SUMMARY.md
          cp -r theme/* std_main_book/theme/
          cp scripts/* std_main_book/scripts/
          cp book.toml std_main_book/book.toml

      - name: Prepare stdx book (main)
        run: |
          set -euxo pipefail
          mkdir -p stdx_main_book/src stdx_main_book/theme stdx_main_book/scripts
          rsync -a --delete ext_stdx_main/doc/* stdx_main_book/src/
          test -f stdx_main_book/src/summary_cjnative.md && mv -f stdx_main_book/src/summary_cjnative.md stdx_main_book/src/SUMMARY.md
          cp -r theme/* stdx_main_book/theme/
          cp scripts/* stdx_main_book/scripts/
          cp book.toml stdx_main_book/book.toml

      - name: Prepare std book (pr)
        if: ${{ env.BUILD_PR == 'true' }}
        run: |
          set -euxo pipefail
          mkdir -p std_pr_book/src std_pr_book/theme std_pr_book/scripts
          mkdir -p std_pr_book/src/vendor/gitcode
          rsync -a --delete ext_pr/stdlib/doc/libs/ std_pr_book/src/vendor/gitcode/

          cp -r std_pr_book/src/vendor/gitcode/* std_pr_book/src/
          rm -rf std_pr_book/src/std_en
          rm -f std_pr_book/src/summary_cjnative_EN.md
          mv -f std_pr_book/src/summary_cjnative.md std_pr_book/src/SUMMARY.md
          cp -r theme/* std_pr_book/theme/
          cp scripts/* std_pr_book/scripts/
          cp book.toml std_pr_book/book.toml

      - name: Prepare stdx book (pr)
        if: ${{ env.BUILD_PR == 'true' }}
        run: |
          set -euxo pipefail
          mkdir -p stdx_pr_book/src stdx_pr_book/theme stdx_pr_book/scripts
          rsync -a --delete ext_stdx_pr/doc/* stdx_pr_book/src/
          test -f stdx_pr_book/src/summary_cjnative.md && mv -f stdx_pr_book/src/summary_cjnative.md stdx_pr_book/src/SUMMARY.md
          cp -r theme/* stdx_pr_book/theme/
          cp scripts/* stdx_pr_book/scripts/
          cp book.toml stdx_pr_book/book.toml

      - name: Sanity check
        run: |
          test -f std_dev_book/src/SUMMARY.md
          test -f stdx_dev_book/src/SUMMARY.md
          test -f std_main_book/src/SUMMARY.md
          test -f stdx_main_book/src/SUMMARY.md
          if [[ "${BUILD_PR}" == "true" ]]; then
            test -f std_pr_book/src/SUMMARY.md
            test -f stdx_pr_book/src/SUMMARY.md
          fi
          sed -n '1,10p' std_dev_book/book.toml
          sed -n '1,10p' stdx_dev_book/scripts/table.py

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-mdbook
          restore-keys: |
            ${{ runner.os }}-cargo-mdbook

      - name: Install Rust (for cargo)
        uses: dtolnay/rust-toolchain@stable

      - name: Install mdBook (pinned)
        run: |
          if ! command -v mdbook >/dev/null; then
            cargo install --locked mdbook --version ${MDBOOK_VERSION}
          fi
          mdbook --version

      - name: Install mdbook-admonish (if needed)
        shell: bash
        env:
          MDBOOK_ADMONISH_VERSION: "1.20.0"
        run: |
          set -euo pipefail
          want_ver="mdbook-admonish $MDBOOK_ADMONISH_VERSION"
          if ! command -v mdbook-admonish >/dev/null; then
            echo "mdbook-admonish not found. Installing..."
            cargo install mdbook-admonish --locked --version "$MDBOOK_ADMONISH_VERSION"
          else
            have_ver="$(mdbook-admonish --version || true)"
            if [[ "$have_ver" == "$want_ver" ]]; then
              echo "mdbook-admonish already $have_ver, skip."
            else
              echo "mdbook-admonish is $have_ver, want $want_ver. Reinstalling..."
              cargo install mdbook-admonish --locked --version "$MDBOOK_ADMONISH_VERSION" --force
            fi
          fi

      - name: Install mdbook-pagetoc(if needed)
        shell: bash
        env:
          MDBOOK_PAGETOC_VERSION: "0.2.2"
        run: |
          set -euo pipefail
          if ! command -v mdbook-pagetoc >/dev/null; then
            echo "mdbook-pagetoc not found. Installing..."
            cargo install mdbook-pagetoc --locked --version "$MDBOOK_PAGETOC_VERSION"
          fi

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: Print mdBook env & where is book.toml
        run: |
          set -euxo pipefail
          mdbook -V
          echo "WORKSPACE = $GITHUB_WORKSPACE"
          echo "--- repo root ---"
          ls -la
          echo "--- show book.toml (if any) ---"
          sed -n '1,120p' book.toml || true

      - name: Build std (dev)
        run: |
          set -euxo pipefail
          cd std_dev_book && mdbook-admonish install
          BASE_TITLE="Cangjie Std API (dev)"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$DEV_STD_OUT_DIR"
          test -f "$DEV_STD_OUT_DIR/index.html"

      - name: Build stdx (dev)
        run: |
          set -euxo pipefail
          cd stdx_dev_book && mdbook-admonish install
          BASE_TITLE="Cangjie Stdx API (dev)"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$DEV_STDX_OUT_DIR"
          test -f "$DEV_STDX_OUT_DIR/index.html"

      - name: Build std (main)
        run: |
          set -euxo pipefail
          cd std_main_book && mdbook-admonish install
          BASE_TITLE="Cangjie Std API (main)"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$MAIN_STD_OUT_DIR"
          test -f "$MAIN_STD_OUT_DIR/index.html"

      - name: Build stdx (main)
        run: |
          set -euxo pipefail
          cd stdx_main_book && mdbook-admonish install
          BASE_TITLE="Cangjie Stdx API (main)"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$MAIN_STDX_OUT_DIR"
          test -f "$MAIN_STDX_OUT_DIR/index.html"

      - name: Build std (pr)
        if: ${{ env.BUILD_PR == 'true' }}
        run: |
          set -euxo pipefail
          cd std_pr_book && mdbook-admonish install
          BASE_TITLE="Cangjie Std API (pr ${PR_ID})"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$PR_STD_OUT_DIR"
          test -f "$PR_STD_OUT_DIR/index.html"

      - name: Build stdx (pr)
        if: ${{ env.BUILD_PR == 'true' }}
        run: |
          set -euxo pipefail
          cd stdx_pr_book && mdbook-admonish install
          BASE_TITLE="Cangjie Stdx API (pr ${PR_ID})"
          TS=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M")
          MDBOOK_BOOK__TITLE="$BASE_TITLE $TS" mdbook build --dest-dir "$PR_STDX_OUT_DIR"
          test -f "$PR_STDX_OUT_DIR/index.html"

      - name: Write redirects and stamps
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/book"
          cat > "$GITHUB_WORKSPACE/book/index.html" <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=./dev/">
              <script>location.replace("./dev/");</script>
              <title>Redirecting…</title>
            </head>
            <body>
              <a href="./dev/">Go to dev docs</a>
            </body>
          </html>
          EOF

          mkdir -p "$GITHUB_WORKSPACE/book/dev" "$GITHUB_WORKSPACE/book/main"
          cat > "$GITHUB_WORKSPACE/book/dev/index.html" <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=./std/">
              <script>location.replace("./std/");</script>
              <title>Redirecting…</title>
            </head>
            <body>
              <a href="./std/">Go to std docs</a>
            </body>
          </html>
          EOF

          cat > "$GITHUB_WORKSPACE/book/main/index.html" <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=./std/">
              <script>location.replace("./std/");</script>
              <title>Redirecting…</title>
            </head>
            <body>
              <a href="./std/">Go to std docs</a>
            </body>
          </html>
          EOF

          if [[ "${BUILD_PR}" == "true" ]]; then
          mkdir -p "$PR_OUT_ROOT"
          cat > "$PR_OUT_ROOT/index.html" <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=./std/">
              <script>location.replace("./std/");</script>
              <title>Redirecting…</title>
            </head>
            <body>
              <a href="./std/">Go to std docs</a>
            </body>
          </html>
          EOF
          date +%s > "$PR_OUT_ROOT/.stamp"
          fi

      - name: Assert book exists
        run: |
          set -euxo pipefail
          test -d "$GITHUB_WORKSPACE/book"
          test -f "$DEV_STD_OUT_DIR/index.html" || (echo "dev std index.html missing" && exit 2)
          test -f "$DEV_STDX_OUT_DIR/index.html" || (echo "dev stdx index.html missing" && exit 2)
          test -f "$MAIN_STD_OUT_DIR/index.html" || (echo "main std index.html missing" && exit 2)
          test -f "$MAIN_STDX_OUT_DIR/index.html" || (echo "main stdx index.html missing" && exit 2)
          grep -nE 'pagetoc\.(js|css)' "$DEV_STD_OUT_DIR/index.html" || echo '未引入 pagetoc 资源'
          find book -path '*/theme/pagetoc.*' -print || echo 'theme/pagetoc.* missing'
          grep -nE 'class="pagetoc|id="pagetoc' "$DEV_STD_OUT_DIR/index.html" || echo '页面里没有 pagetoc 容器（JS 可能没运行）'
          if [[ "${BUILD_PR}" == "true" ]]; then
            test -f "$PR_STD_OUT_DIR/index.html" || (echo "pr std index.html missing" && exit 2)
            test -f "$PR_STDX_OUT_DIR/index.html" || (echo "pr stdx index.html missing" && exit 2)
            test -f "$PR_OUT_ROOT/.stamp" || (echo "pr stamp missing" && exit 2)
          fi
          find book -maxdepth 5 -type f -name 'toc.js' -print

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./book
  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
